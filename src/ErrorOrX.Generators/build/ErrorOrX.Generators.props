<Project>
    <PropertyGroup>
        <!--
            IMPORTANT: ErrorOrGenerateJsonContext is disabled by default.

            The generated ErrorOrJsonContext CANNOT be used for Native AOT because Roslyn
            source generators cannot see output from other generators. The System.Text.Json
            source generator will not process our generated JsonSerializerContext.

            For AOT compatibility, you MUST create your own JsonSerializerContext:

            [JsonSerializable(typeof(YourType))]
            internal partial class AppJsonSerializerContext : JsonSerializerContext { }

            And register it:
            builder.Services.AddErrorOrEndpoints(o => o.UseJsonContext<AppJsonSerializerContext>());

            See: https://learn.microsoft.com/aspnet/core/fundamentals/aot/request-delegate-generator/rdg
        -->
        <ErrorOrGenerateJsonContext Condition="'$(ErrorOrGenerateJsonContext)' == ''">false</ErrorOrGenerateJsonContext>
        <!-- Enable XML documentation for OpenAPI parameter descriptions -->
        <GenerateDocumentationFile Condition="'$(GenerateDocumentationFile)' == ''">true</GenerateDocumentationFile>
        <!-- Suppress XML doc warnings (CS1591: missing XML comment, CS1573: missing param tag) -->
        <NoWarn>$(NoWarn);CS1591;CS1573</NoWarn>
    </PropertyGroup>

    <ItemGroup>
        <!-- Make MSBuild properties visible to the source generator -->
        <CompilerVisibleProperty Include="ErrorOrGenerateJsonContext"/>
        <CompilerVisibleProperty Include="PublishAot"/>
    </ItemGroup>

    <!--
        Workaround for developmentDependency=true hiding ErrorOrX runtime.
        When ErrorOrX.Generators is installed via 'dotnet add package', NuGet adds
        PrivateAssets=all due to developmentDependency=true. This target runs after
        NuGet restore and adds an explicit ErrorOrX reference if missing.
    -->
    <Target Name="EnsureErrorOrXRuntimeFlows" BeforeTargets="ResolvePackageAssets">
        <ItemGroup>
            <!-- Get the version of ErrorOrX.Generators that was installed -->
            <_ErrorOrXGenVersion Include="@(PackageReference->WithMetadataValue('Identity', 'ErrorOrX.Generators')->Metadata('Version'))" />

            <!-- Add ErrorOrX with same version if not already present with PrivateAssets=none -->
            <PackageReference Include="ErrorOrX"
                              Version="%(_ErrorOrXGenVersion.Identity)"
                              Condition="'%(_ErrorOrXGenVersion.Identity)' != '' AND '@(PackageReference->WithMetadataValue('Identity', 'ErrorOrX'))' == ''"
                              PrivateAssets="none" />
        </ItemGroup>
    </Target>
</Project>
